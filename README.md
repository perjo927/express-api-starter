# perjo927/express-api-starter

## Description

A simple Express-based versioned API that implements both public and protected routes. The authentication is handled by passport. After calling the `/authorize` route with an id token, verified by Firebase or provider of choice, a JWT access token is generated (needs the environment variable ACCESS_TOKEN_SECRET to be set) returned to the consumer. Consumers can then pass the token in the Authorization header as Bearer to access routes with authentication, by default `/test-authorize`. The Firebase integration is mocked away in the case it would not the the desired integration, however it can be toggled back, see instructions further down.

See test client repo [TODO:]() for example usage!

- Firebase (disabled by default) is used as a database.
- For testing, SuperTest and Jest are being used.
- Linting and formatting are managed by ESLint and Prettier.
- CI/CD is handled through Github Actions.
- The application can also be packaged as a docker container.
- Environment variables can be provided locally through a .env file.
- For logging, winston and morgan are being used.

## Routes

Endpoint: `api/v1/`

The starter repo comes with three routes by default, as described below. One for alive checking, one for retrieving the access token plus one for testing the token.

The `/authorize` route controller will verify the id token passed in the body. If you are using Firebase for instance, the id token will be generated by Firebase when signing in to the client, and verified by Firebase after it has been passed to the server.

Remember to generate an access token string so that a JWT can be generated. Then populate the environment variable `ACCESS_TOKEN_SECRET`. You could get started with [crypto](https://nodejs.org/api/crypto.html#crypto_crypto).

You can then verify that protected routes work by passing the access token in an Authorization header to `test-auth`.

| Routes     | Method | Headers                     | Body     | Response        |
| ---------- | :----- | :-------------------------- | :------- | :-------------- |
| /ping      | GET    |                             |          | "pong"          |
| /authorize | POST   |                             | id_token | { accessToken } |
| /test-auth | GET    | Authorization: Bearer token |          | 200 or 401      |

Not found routes respond with 404 and server errors with 5XX.

## Pre-requisites for Development

- Make sure to have [Node.js](https://nodejs.org/en/) and [nvm](https://github.com/nvm-sh/nvm) installed.

- Create a `.env` file in the root folder.

  - Populate it with the process variables of your choosing, example:

    ```
    NODE_ENV=development
    PORT=<Your favorite port number>
    ACCESS_TOKEN_SECRET=<Generate yourself>
    ```
- If you are using Firebase, you can choose to provide a service account json file (see: `data/service-account.js`). You also need to require firebase-admin (see: `data/admin.js`)

## Production
Choose your favorite provider; build docker using the production script, push and deploy the docker container and remember to configure the environment variables in the production environment.

## Install

`$ git clone https://github.com/perjo927/express-api-starter

`$ cd perjo927/express-api-starter`

`$ nvm use`

`$ npm ci`

## Development Server

`$ npm run start:dev`

## Use Docker

`$ npm run start:docker:dev`
`$ npm run stop:docker`

## Test
The project is covered almost 100% by unit tests out of the box.

### Single Run

`$ npm run test`

### Watch

`$ npm run test:watch`

## Author

Per Jonsson
